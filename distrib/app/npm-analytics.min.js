"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};;(function(moduleName,root,factory){/* eslint-disable */if(typeof define==="function"&&define.amd){}else if((typeof exports==="undefined"?"undefined":_typeof(exports))==="object"){module.exports=factory();}else{window.http=factory();}/* eslint-enable */})("http",null,function(){"use strict";var http={};http.getJSON=function(url){return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest();xhr.onload=function(){return resolve(xhr.response);};xhr.onerror=function(){return reject(xhr.statusText);};xhr.open("GET",url,true);xhr.responseType="json";xhr.send(null);});};http.postJSON=function(url,data){return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest();xhr.onload=function(){return resolve(xhr.response);};xhr.onerror=function(){return reject(xhr.statusText);};xhr.open("POST",url,true);xhr.responseType="json";xhr.setRequestHeader("Content-Type","application/json");xhr.send(JSON.stringify(data));});};http.ajax=function(url,method,data,headers){return new Promise(function(resolve,reject){var xhr=new XMLHttpRequest();xhr.onload=function(){return resolve(xhr.response);};xhr.onerror=function(){return reject(xhr.statusText);};xhr.open(method,url,true);//  xhr.responseType = 'json';
if(headers){for(var h in headers){xhr.setRequestHeader(h,headers[h]);}}data=data||null;xhr.send(data);});};return http;});(function(){/* global moment,Chart,http *//* eslint-disable */var stats=[];var chartData={};/* eslint-enable */document.ready(function(){document.querySelector("#start").value=moment().add(-7,"day").format("YYYY-MM-DD");document.querySelector("#end").value=moment().add(-1,"day").format("YYYY-MM-DD");var lastSearch=localStorage.getItem("lastSearch");/* eslint-disable */if(lastSearch!=null){/* eslint-enable */lastSearch=JSON.parse(lastSearch);document.querySelector("#typeSearch").value=lastSearch.typeSearch;document.querySelector("#search").value=lastSearch.search;updateGraphics();}document.querySelector("#btnOk").onclick=updateGraphics;});function createColorsArrays(nb){var inc=nb%255;var arr=[];for(var i=0;i<=nb;i++){arr.push("rgba("+(255-i*inc)+","+(100+i*inc)%255+","+i*inc+",0.9)");}return arr;}function updateGraphics(){var start=document.querySelector("#start").value;var end=document.querySelector("#end").value;var typeSearch=document.querySelector("#typeSearch").value;var search=document.querySelector("#search").value;var startDate=moment(start);var endDate=moment(end);var url="http://localhost:59867/api/Proxy/CallForMe";// url = "http://proxy.lesprojets.net/api/Proxy/CallForMe";
localStorage.setItem("lastSearch",JSON.stringify({typeSearch:typeSearch,search:search}));//url = "http://proxy.lesprojets.net/api/Proxy/CallForMe";
if(typeSearch==="User"){http.postJSON(url,{url:"https://api.npms.io/v2/search?q=maintainer:"+search,method:"GET"}).then(function(data){var packages=data.results.map(function(x){return x.package;});var promises=packages.map(function(x){return http.postJSON(url,{url:["https://api.npmjs.org/downloads/range/",startDate.format("YYYY-MM-DD"),":",endDate.format("YYYY-MM-DD"),"/",x.name].join(""),method:"GET"});});stats=[];chartData={};Promise.all(promises).then(function(response){stats=response.filter(function(n){return n!==null;});redraw();});});}else if(typeSearch==="Package"){var urlNpm=["https://api.npmjs.org/downloads/range/",startDate.format("YYYY-MM-DD"),":",endDate.format("YYYY-MM-DD"),"/",search].join("");http.postJSON(url,{url:urlNpm,method:"GET"}).then(function(data){stats=[data];redraw();});}}function redrawArray(){var datasets=[];var total=0;for(var i=0;i<stats.length;i++){var dataset={label:stats[i].package,downloads:stats[i].downloads.reduce(function(accu,cur){return accu+=cur.downloads;},0)};total+=dataset.downloads;datasets.push(dataset);}var st="";var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=datasets[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var d=_step.value;st+=["<tr><td>",d.label,"</td><td class=num>",d.downloads,"</td></tr>"].join("");}}catch(err){_didIteratorError=true;_iteratorError=err;}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return();}}finally{if(_didIteratorError){throw _iteratorError;}}}st+=["<tr><td>","Total","</td><td class=num>",total,"</td></tr>"].join("");document.getElementById("myData").html(st);}var chart=null;function redraw(){var colors=createColorsArrays(stats.length);redrawArray();chartData.labels=stats[0].downloads.map(function(x){return x.day;});chartData.datasets=[];for(var i=0;i<stats.length;i++){var dataset={label:stats[i].package,data:stats[i].downloads.map(function(x){return x.downloads;}),backgroundColor:colors[i]};chartData.datasets.push(dataset);}if(chart===null){var ctx=document.getElementById("myChart");chart=new Chart(ctx,{type:"bar",options:{scales:{yAxes:[{ticks:{beginAtZero:true}}]},title:{display:true,text:"Stats"},legend:{display:true,position:"bottom"}}});}chart.data.datasets=chartData.datasets;chart.data.labels=chartData.labels;chart.update();}})();